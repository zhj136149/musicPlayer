var root=window;
var $scope=$(document.body);
var song=[
	{
		"image":"../source/songPic/song_1.jpg",
		"audio":"../source/songs/song_1.mp3",
		"song":"丑八怪",
		"label1":"MV",
		"label2":"高清音质",
		"description":"薛之谦专辑",
		"lyrics":"<p>歌名：丑八怪</p><p>演唱：薛之谦</p><p>作词：甘世佳</p><p>作曲：李荣浩</p><p>如果世界漆黑 其实我很美</p><p>在爱情里面进退 最多被消费</p><p>无关痛痒的是非 又怎么不对 无所谓</p><p>如果像你一样 总有人赞美</p><p>围绕着我的卑微 也许能消退</p><p>其实我并不在意 有很多机会</p><p>像巨人一样的无畏</p><p>放纵我心里的鬼</p><p>可是我不配</p><p>丑八怪 能否别把灯打开</p><p>我要的爱 出没在漆黑一片的舞台</p><p>丑八怪 在这暧昧的时代</p><p>我的存在 像意外</p><p></p><p></><p>有人用一滴泪 会红颜祸水</p><p>有人丢掉称谓 什么也不会</p><p>只要你足够虚伪 就不怕魔鬼 对不对</p><p>如果剧本写好 谁比谁高贵</p><p>我只能沉默以对 美丽本无罪</p><p>当欲望开始贪杯 有更多机会</p><p>像尘埃一样的无畏</p><p>化成灰谁认得谁</p><p>管他配不配</p><p>丑八怪 能否别把灯打开</p><p>我要的爱 出没在漆黑一片的舞台</p><p>丑八怪 在这暧昧的时代</p><p>我的存在 不意外</p>",
		"album":"意外",
		"singer":"薛之谦",
		"srouce":"搜索页",
		"duration":253,
		"flag":false,
		"islike":true
	},
	{
		"image":"../source/songPic/song_2.jpg",
		"audio":"../source/songs/song_2.mp3",
		"song":"小梦",
		"label1":"MV",
		"label2":"高清音质",
		"description":"小梦大梦",
		"lyrics":"<p>歌名：小半</p><p>作词：涂玲子</p><p>作曲：陈粒</p><p>不敢回看</p><p>左顾右盼不自然的暗自喜欢</p><p>偷偷搭讪总没完地坐立难安</p><p>试探说晚安</p><p>多空泛又心酸</p><p>低头呢喃</p><p>对你的偏爱太过于明目张胆</p><p>在原地打转的小丑伤心不断</p><p>空空留遗憾</p><p>多难堪又为难</p><p>释然 慵懒 尽欢</p><p>时间风干后你与我再无关</p><p>没答案</p><p>怎么办</p><p>看不惯自我欺瞒</p><p>纵容着 喜欢的 讨厌的 宠溺的 厌倦的</p><p>一个个慢慢黯淡</p><p>纵容着 任性的 随意的 放肆的 轻易的</p><p>将所有欢脱倾翻</p><p>不应该 太心软 不大胆 太死板 不果断</p><p>玩弄着肆无忌惮</p><p>不应该 舍弃了 死心了 放手了 断念了</p><p>无可奈何不耐烦</p><p>不算</p><p></p><p></p><p></p><p></p><p>灯火阑珊</p><p>我的心借了你的光是明是暗</p><p>笑自己情绪太泛滥形只影单</p><p>自嘲成习惯</p><p>多敏感又难缠</p><p>低头呢喃</p><p>对你的偏爱太过于明目张胆</p><p>在原地打转的小丑伤心不断</p><p>空空留遗憾</p><p>多难堪又为难</p><p>释然 慵懒 尽欢</p><p>时间风干后你与我再无关</p><p>没答案</p><p>怎么办</p><p>看不惯自我欺瞒</p><p>纵容着 喜欢的 讨厌的 宠溺的 厌倦的</p><p>一个个慢慢黯淡</p><p>纵容着 任性的 随意的 放肆的 轻易的</p><p>将所有欢脱倾翻</p><p>不应该 太心软 不大胆 太死板 不果断</p><p>玩弄着肆无忌惮</p><p>不应该 舍弃了 死心了 放手了 断念了</p><p>无可奈何不耐烦</p><p>任由着 你躲闪 我追赶 你走散 我呼喊</p><p>是谁在泛泛而谈</p><p>任由着 你来了 你笑了 你走了 不看我</p><p>与理所当然分摊</p><p>不明白 残存的 没用的 多余的 不必的</p><p>破烂也在手紧攥</p><p>不明白 谁赧然 谁无端 谁古板 谁极端</p><p>无辜不知所以然</p><p>纵容着 喜欢的 讨厌的 宠溺的 厌倦的</p><p>一个个慢慢黯淡</p><p>纵容着 任性的  随意的 放肆的 轻易的</p><p>将所有欢脱倾翻</p><p>不应该 太心软 不大胆 太死板 不果断</p><p>玩弄着肆无忌惮</p><p>不应该 舍弃了 死心了 放手了 断念了</p><p>无可奈何不耐烦 </p>",
		"album":"大梦小梦",
		"singer":"陈粒",
		"srouce":"搜索页",
		"duration":297,
		"flag":true,
		"islike":false
	},
	{
		"image":"../source/songPic/song_3.jpg",
		"audio":"../source/songs/song_3.mp3",
		"song":"丑八怪2",
		"label1":"MV3",
		"label2":"高清音质3",
		"description":"薛之谦专辑3",
		"lyrics":"{[1],[2],[3],[4]}3",
		"album":"意外3",
		"singer":"薛之谦3",
		"srouce":"搜索页3",
		"duration":259,
		"flag":true,
		"islike":true
	}
];

var index=0;
var indexF;
var P=0;
var sound=0.1;
function render(song,index){
	
	var lastPercentage=0;
	var alltime;
	var percentage;
	var curDuration;
	var frameId;
	var curTime;
	var duringtimes;
	function renderInfo(){
		var a=song[index];
		var html1='<div class="main-info">'+
							"<p>"+
								'<span class="music-name">'+a.song+'</span>'+
								'<span class="label">'+a.label1+'</span>'+
								'<span class="label">'+a.label2+'</span>'+
							'</p>'+
							'<p> <span class="srouce">'+a.description+'</span></p>'+
							'<p>'+ 
								'<span>专辑：</span><a href="#">'+a.album+'</a>'+
								'<span>歌手：</span><a href="#">'+a.singer+'</a>'+
								'<span>来源：</span><a href="#">'+a.srouce+'</a>'+
							'</p>'+
						'</div>'+
						'<div class="music-text">'+
							'<div class="text-warpper">'+ a.lyrics+'</div>'+
						"</div>";
		 alltime=formatTime(song[index].duration);
		 curDuration=song[index].duration;
		$('.allTime').text(alltime);
		$('.music-info')[0].innerHTML=html1;

	}
	function renderImage(){
		   var a=song[index];
			$('.music-round .round .round-image img').attr("src",a.image);
			// $('.main-body .main-top').css("background","red");
			// var bodyImg=$('.main-top')[0];
			// console.log(bodyImg);
		 	// root.blurImg(a.image,body);
		 //   	img.src=a.image;
	}
	function formatTime(time){
		time=Math.round(time);
		var minute=Math.floor(time/60);
		var second=time-minute*60;
		if (minute<10) {
			minute="0"+minute;
		}
		if(second<10){
			second="0"+second;
		}
		return minute+":"+second;
	}
	function progress(percentage){
		var percent=(percentage-1)*100+"%";
		$('.footer .foot-timeBar .timeBar-warpper .top-timeBar').css({"transform":"translateX("+percent+")"});
	}
	function updata(percentage){
		var curTime=formatTime(percentage*curDuration);
		$('.nowTime').text(curTime);
	}
	function startTime(){
		console.log(index);
		var starttime=new Date().getTime();
		function frame(){
			var currenttime= new Date().getTime();
			var duringtime=(currenttime - starttime)/(curDuration*1000)
			percentage=lastPercentage+duringtime;
			duringtimes=duringtime;
			if(percentage<1){
				// console.log(percentage);
				updata(percentage);
				frameId= requestAnimationFrame(frame);
			}else{
				cancelAnimationFrame(frameId);
			}
			progress(percentage);
		}
		frame();
	}
	function stopTime(){
		console.log(index);
		 curTime=new Date().getTime();
		 lastPercentage=lastPercentage+duringtimes;
		cancelAnimationFrame(frameId);
	}
	renderInfo();
	renderImage();
	// startTime();
	console.log("状态：",song[index].flag);
	$scope.on('click',".pause-btn",function(){
		indexF=index;
		console.log(indexF);
		if(!song[index].flag){
			stopTime();
		}else{
			startTime();
		}
	})

	if(indexF!==index&&indexF!==undefined){
		percentage=0;
		lastPercentage=0;
		updata(percentage);
		progress(percentage);
		if(!song[index].flag){
			cancelAnimationFrame(frameId);
		// stopTime();
			
		}
	}
}
	
function audioManage(song,index){
		var audio=new Audio();
		audioManage.prototype={
			playMuisc: function(){
				audioManage.prototype.musicText();
				$('.music-round .zhen').removeClass('music-pause');
				$('.footer .foot-btn .pause-btn').removeClass('play');
				$('.music-round .round').removeClass('round-pause');
				$('.text-warpper').removeClass('text-pause');
				audio.play();
				timestop=false;
				song[index].flag=true;
			},
			pauseMuisc:function(){
				audio.pause();
				$('.music-round .zhen').addClass('music-pause');
				$('.footer .foot-btn .pause-btn').addClass('play');
				$('.music-round .round').addClass('round-pause');
				$('.text-warpper').addClass('text-pause');
				song[index].flag=false;
				timestop=true;
				// console.log(audio.ended);
			},
			setAudioSource:function(){
				audio.src=song[index].audio;
				audio.load();
				audio.autoplay=false;
			},
			setAudioSound:function(){
				if(sound==0){
					audio.muted=true;
				}else{
					audio.muted=false;
				}
				var soundPercent=(sound-1)*100+"%";
				audio.volume=sound;
				$('.soundBar-warpper .top-soundBar').css({"transform":"translateX("+soundPercent+")"});
			},
			musicText: function(){
				// var temp=setInterval(function(){
					// console.log(P);
					// P++;
					// var text=$('.text-warpper p')[P];
					// console.log(text);
					// var textUp=120-30*P+"px";
					var time=song[index].duration;
					console.log(time);
					// console.log(a);
					$('.text-warpper').css({"animation-duration": time+"s"});
					// $('.text-warpper').css({"transform":"translateY("+textUp+")"});			
					// },2000);
			}
		}
		if(song[index].flag){
			audioManage.prototype.playMuisc();
		}else{
			audioManage.prototype.setAudioSource();

			audioManage.prototype.pauseMuisc();
		}

		if(audio.ended){
			console.log(audio.ended);
			console.log(index);
			index++;
			console.log(index);
			render(song,index);
		}
	$scope.on('click',".prev-btn",function(){
		
		indexF=index;
		song[indexF].flag=false;
		if(index===0){
			index=song.length-1;
		}else
		index--;
		audioManage.prototype.pauseMuisc();
		audioManage.prototype.setAudioSource();
		render(song,index);
		song[index].flag=false;

	})
	$scope.on('click',".next-btn",function(){
		indexF=index;
		song[indexF].flag=false;
		if(index===song.length-1){
			index=0;
		}else{
			index++;
		}
		audioManage.prototype.pauseMuisc();
		audioManage.prototype.setAudioSource();
		render(song,index);
		song[index].flag=false;

	})
	$scope.on('click',".pause-btn",function(){
		if(song[index].flag){
			song[index].flag=false;
			 audioManage.prototype.pauseMuisc();
		}else{
			song[index].flag=true;			
			audioManage.prototype.playMuisc();
		}
	})
	$scope.on('click',".sound-btn",function(){
		if(sound==0){
			$('.sound-btn').removeClass('sound-muted');
			sound=0.1;
		}else{
			$('.sound-btn').addClass('sound-muted');			
			sound=0;
		}
		audioManage.prototype.setAudioSound();
	})
	$scope.on('click',".bottom-soundBar",function(){
		if(sound==0){
			$('.sound-btn').toggleClass('sound-muted');
		}
		sound=sound+0.1;
		if(sound>1||sound==1){
			sound=1;
		}
		audioManage.prototype.setAudioSound();
	})
		$scope.on('click',".top-soundBar",function(){
		if(sound==0){
			$('.sound-btn').toggleClass('sound-muted');
		}
		sound=sound-0.1;
		if(sound<0||sound==0){
			sound=0;
		}
		audioManage.prototype.setAudioSound();
	})
}
audioManage(song,index);
render(song,index);

